<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Selection Probability - Clean Experiment</title>

    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        :root {
            --color-primary: #4ECDC4;
            --color-secondary: #FF6B6B;
            --color-accent: #FFE66D;
            --bg-main: #F7F7F7;
            --bg-card: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --exp1-color: #667eea;
            --exp2-color: #f093fb;
            --exp3-color: #4facfe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-main);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 2.5rem;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .control-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-row label {
            font-weight: 600;
            min-width: 200px;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: var(--text-secondary);
        }

        button.run-all {
            background: var(--color-secondary);
            font-size: 1.1rem;
            padding: 15px 30px;
        }

        input[type="number"] {
            padding: 10px;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            font-size: 1rem;
            width: 80px;
            text-align: center;
        }

        /* Experiments Grid */
        .experiments-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .experiments-grid {
                grid-template-columns: 1fr;
            }
        }

        .experiment-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid var(--exp1-color);
        }

        .experiment-card:nth-child(2) {
            border-top-color: var(--exp2-color);
        }

        .experiment-card:nth-child(3) {
            border-top-color: var(--exp3-color);
        }

        .experiment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .experiment-header h2 {
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .experiment-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--exp1-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .experiment-card:nth-child(2) .experiment-number {
            background: var(--exp2-color);
        }

        .experiment-card:nth-child(3) .experiment-number {
            background: var(--exp3-color);
        }

        .config-section {
            background: #F7FAFC;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-row:last-child {
            margin-bottom: 0;
        }

        .config-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .config-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .config-inputs input {
            width: 60px;
        }

        .theory-display {
            background: linear-gradient(135deg, var(--exp1-color), #8b9aed);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .experiment-card:nth-child(2) .theory-display {
            background: linear-gradient(135deg, var(--exp2-color), #f3a4fc);
        }

        .experiment-card:nth-child(3) .theory-display {
            background: linear-gradient(135deg, var(--exp3-color), #73c4ff);
        }

        .theory-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .theory-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .theory-fraction {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-section {
            margin-bottom: 20px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: #E2E8F0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-card {
            background: #F7FAFC;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .result-row:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .result-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .result-value.highlight {
            color: var(--color-secondary);
            font-size: 1.3rem;
        }

        .difference {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 10px;
        }

        .difference.good {
            background: #C6F6D5;
            color: #22543D;
        }

        .difference.warning {
            background: #FEF5E7;
            color: #7D6608;
        }

        .chart-container {
            height: 200px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .comparison-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .comparison-chart {
            height: 300px;
            margin-top: 20px;
        }

        .compound-contribution {
            background: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .compound-contribution h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .compound-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .compound-row:last-child {
            border-bottom: none;
        }

        .compound-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .compound-value {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pattern-analysis {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .pattern-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .pattern-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .pattern-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .pattern-formula {
            background: #2D3748;
            color: #F7FAFC;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .formula-step {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .formula-result {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #4ECDC4;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-accent);
        }

        .pattern-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .pattern-card {
            background: linear-gradient(135deg, var(--color-primary), #45b7aa);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .pattern-card:last-child {
            background: linear-gradient(135deg, var(--color-secondary), #ee5a6f);
        }

        .pattern-card-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .pattern-card-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .pattern-card-subtext {
            font-size: 1rem;
            opacity: 0.9;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ Imposter Selection Experiments</h1>
        <p class="subtitle">Clean experiments to test selection probability - No game clustering</p>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-row">
                <label>How many selections per experiment?</label>
                <div class="preset-buttons">
                    <button onclick="app.setCount(10)">10</button>
                    <button onclick="app.setCount(100)">100</button>
                    <button onclick="app.setCount(500)">500</button>
                    <button onclick="app.setCount(1000)">1,000</button>
                    <button onclick="app.setCount(10000)">10,000</button>
                </div>
                <input type="number" id="custom-count" value="1000" min="1" max="100000">
            </div>

            <div class="control-row">
                <button class="run-all" onclick="app.runAllExperiments()" id="run-button">
                    ‚ñ∂ Run All Experiments
                </button>
                <button class="secondary" onclick="app.resetToJenScenario()">
                    Reset to Jen Scenario
                </button>
                <button class="secondary" onclick="app.clearResults()">
                    Clear Results
                </button>
            </div>
        </div>

        <!-- Experiments Grid -->
        <div class="experiments-grid">
            <!-- Experiment 1 -->
            <div class="experiment-card">
                <div class="experiment-header">
                    <h2>Experiment 1</h2>
                    <div class="experiment-number">1</div>
                </div>

                <div class="config-section">
                    <div class="config-row">
                        <span class="config-label">Players:</span>
                        <div class="config-inputs">
                            <input type="number" id="exp1-players" value="17" min="1" max="50">
                        </div>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Imposters:</span>
                        <div class="config-inputs">
                            <input type="number" id="exp1-imposters" value="3" min="1" max="10">
                        </div>
                    </div>
                </div>

                <div class="theory-display">
                    <div class="theory-label">Theoretical Probability</div>
                    <div class="theory-value" id="exp1-theory-percent">17.65%</div>
                    <div class="theory-fraction" id="exp1-theory-fraction">(3/17)</div>
                </div>

                <div class="progress-section" id="exp1-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp1-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="exp1-progress-text">0 / 1000</div>
                </div>

                <div class="results-section" id="exp1-results">
                    <div class="result-card">
                        <div class="result-row">
                            <span class="result-label">Total Selections:</span>
                            <span class="result-value" id="exp1-total">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Jen Selected:</span>
                            <span class="result-value highlight" id="exp1-selected">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Actual %:</span>
                            <span class="result-value highlight" id="exp1-actual-percent">-</span>
                        </div>
                    </div>
                    <div class="difference" id="exp1-diff">-</div>

                    <div class="compound-contribution">
                        <h4>üìê Compound Probability Contribution</h4>
                        <div class="compound-row">
                            <span class="compound-label">P(selected):</span>
                            <span class="compound-value" id="exp1-p-selected">-</span>
                        </div>
                        <div class="compound-row">
                            <span class="compound-label">P(not selected):</span>
                            <span class="compound-value" id="exp1-p-not-selected">-</span>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="exp1-chart"></canvas>
                    </div>
                </div>

                <div class="empty-state" id="exp1-empty">
                    <p>Configure and run to see results</p>
                </div>
            </div>

            <!-- Experiment 2 -->
            <div class="experiment-card">
                <div class="experiment-header">
                    <h2>Experiment 2</h2>
                    <div class="experiment-number">2</div>
                </div>

                <div class="config-section">
                    <div class="config-row">
                        <span class="config-label">Players:</span>
                        <div class="config-inputs">
                            <input type="number" id="exp2-players" value="17" min="1" max="50">
                        </div>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Imposters:</span>
                        <div class="config-inputs">
                            <input type="number" id="exp2-imposters" value="3" min="1" max="10">
                        </div>
                    </div>
                </div>

                <div class="theory-display">
                    <div class="theory-label">Theoretical Probability</div>
                    <div class="theory-value" id="exp2-theory-percent">17.65%</div>
                    <div class="theory-fraction" id="exp2-theory-fraction">(3/17)</div>
                </div>

                <div class="progress-section" id="exp2-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp2-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="exp2-progress-text">0 / 1000</div>
                </div>

                <div class="results-section" id="exp2-results">
                    <div class="result-card">
                        <div class="result-row">
                            <span class="result-label">Total Selections:</span>
                            <span class="result-value" id="exp2-total">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Jen Selected:</span>
                            <span class="result-value highlight" id="exp2-selected">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Actual %:</span>
                            <span class="result-value highlight" id="exp2-actual-percent">-</span>
                        </div>
                    </div>
                    <div class="difference" id="exp2-diff">-</div>

                    <div class="compound-contribution">
                        <h4>üìê Compound Probability Contribution</h4>
                        <div class="compound-row">
                            <span class="compound-label">P(selected):</span>
                            <span class="compound-value" id="exp2-p-selected">-</span>
                        </div>
                        <div class="compound-row">
                            <span class="compound-label">P(not selected):</span>
                            <span class="compound-value" id="exp2-p-not-selected">-</span>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="exp2-chart"></canvas>
                    </div>
                </div>

                <div class="empty-state" id="exp2-empty">
                    <p>Configure and run to see results</p>
                </div>
            </div>

            <!-- Experiment 3 -->
            <div class="experiment-card">
                <div class="experiment-header">
                    <h2>Experiment 3</h2>
                    <div class="experiment-number">3</div>
                </div>

                <div class="config-section">
                    <div class="config-row">
                        <span class="config-label">Players:</span>
                        <div class="config-inputs">
                            <input type="number" id="exp3-players" value="18" min="1" max="50">
                        </div>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Imposters:</span>
                        <div class="config-inputs">
                            <input type="number" id="exp3-imposters" value="2" min="1" max="10">
                        </div>
                    </div>
                </div>

                <div class="theory-display">
                    <div class="theory-label">Theoretical Probability</div>
                    <div class="theory-value" id="exp3-theory-percent">11.11%</div>
                    <div class="theory-fraction" id="exp3-theory-fraction">(2/18)</div>
                </div>

                <div class="progress-section" id="exp3-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp3-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="exp3-progress-text">0 / 1000</div>
                </div>

                <div class="results-section" id="exp3-results">
                    <div class="result-card">
                        <div class="result-row">
                            <span class="result-label">Total Selections:</span>
                            <span class="result-value" id="exp3-total">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Jen Selected:</span>
                            <span class="result-value highlight" id="exp3-selected">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Actual %:</span>
                            <span class="result-value highlight" id="exp3-actual-percent">-</span>
                        </div>
                    </div>
                    <div class="difference" id="exp3-diff">-</div>

                    <div class="compound-contribution">
                        <h4>üìê Compound Probability Contribution</h4>
                        <div class="compound-row">
                            <span class="compound-label">P(selected):</span>
                            <span class="compound-value" id="exp3-p-selected">-</span>
                        </div>
                        <div class="compound-row">
                            <span class="compound-label">P(not selected):</span>
                            <span class="compound-value" id="exp3-p-not-selected">-</span>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="exp3-chart"></canvas>
                    </div>
                </div>

                <div class="empty-state" id="exp3-empty">
                    <p>Configure and run to see results</p>
                </div>
            </div>
        </div>

        <!-- Jen's Pattern Analysis -->
        <div class="pattern-analysis" id="pattern-analysis" style="display:none;">
            <div class="pattern-header">
                <h2>üéØ Jen's Pattern Probability</h2>
                <p>Based on experimental results: Selected in Exp 1, NOT in Exp 2, Selected in Exp 3</p>
            </div>

            <div class="pattern-formula" id="pattern-formula">
                <div class="formula-step">P(Jen's pattern) = P(selected in 1) √ó P(not selected in 2) √ó P(selected in 3)</div>
                <div class="formula-step" id="formula-calculation">= Loading...</div>
                <div class="formula-result" id="formula-result">= Loading...</div>
            </div>

            <div class="pattern-comparison">
                <div class="pattern-card">
                    <div class="pattern-card-label">Experimental Result</div>
                    <div class="pattern-card-value" id="pattern-experimental">-</div>
                    <div class="pattern-card-subtext" id="pattern-experimental-odds">-</div>
                </div>
                <div class="pattern-card">
                    <div class="pattern-card-label">Theoretical Prediction</div>
                    <div class="pattern-card-value">1.61%</div>
                    <div class="pattern-card-subtext">(1 in 62)</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px; padding: 15px; background: #F7FAFC; border-radius: 8px;">
                <div id="pattern-verdict" style="font-size: 1.1rem; font-weight: 600;"></div>
            </div>
        </div>

        <!-- Comparison Section -->
        <div class="comparison-section" id="comparison-section" style="display:none;">
            <h2>üìä Side-by-Side Comparison</h2>
            <div class="comparison-chart">
                <canvas id="comparison-chart"></canvas>
            </div>
        </div>

        <!-- Full Jen Story Simulation -->
        <div class="pattern-analysis" id="jen-story-simulation" style="display:none;">
            <div class="pattern-header">
                <h2>üé≠ Ultimate Validation: Full Jen Story Simulation</h2>
                <p>Simulate complete 3-round games and count how many match Jen's exact pattern</p>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    Each simulation runs 3 complete rounds using your experiment configurations,
                    then checks if the pattern matches: <strong>Selected in Round 1, NOT in Round 2, Selected in Round 3</strong>
                </p>
                <div class="preset-buttons" style="justify-content: center;">
                    <button onclick="app.runJenStorySimulation(100)">100 Games</button>
                    <button onclick="app.runJenStorySimulation(1000)">1,000 Games</button>
                    <button onclick="app.runJenStorySimulation(10000)">10,000 Games</button>
                </div>
            </div>

            <div class="progress-container" id="jen-story-progress" style="display:none; margin: 20px 0;">
                <p style="margin-bottom: 10px; font-weight: 500; text-align: center;">
                    Running <span id="jen-story-total">0</span> complete 3-round games... <span id="jen-story-current">0</span>
                </p>
                <div class="progress-bar">
                    <div class="progress-fill" id="jen-story-progress-fill"></div>
                </div>
            </div>

            <div id="jen-story-results" style="display:none;">
                <div class="pattern-formula">
                    <div class="formula-step">Games matching Jen's pattern: <span id="jen-story-matches" style="color: var(--color-accent);">-</span></div>
                    <div class="formula-step">Total games simulated: <span id="jen-story-games" style="color: var(--color-accent);">-</span></div>
                    <div class="formula-result" id="jen-story-percent">Percentage: -</div>
                </div>

                <div class="pattern-comparison">
                    <div class="pattern-card">
                        <div class="pattern-card-label">Full Simulation Result</div>
                        <div class="pattern-card-value" id="jen-story-sim-percent">-</div>
                        <div class="pattern-card-subtext" id="jen-story-sim-odds">-</div>
                    </div>
                    <div class="pattern-card">
                        <div class="pattern-card-label">Theoretical (from math)</div>
                        <div class="pattern-card-value">1.61%</div>
                        <div class="pattern-card-subtext">(1 in 62)</div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #F7FAFC; border-radius: 8px;">
                    <div id="jen-story-verdict" style="font-size: 1.1rem; font-weight: 600;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            charts: {},
            comparisonChart: null,

            // Configuration
            setCount(count) {
                document.getElementById('custom-count').value = count;
            },

            getCount() {
                return parseInt(document.getElementById('custom-count').value);
            },

            getExperimentConfig(expNum) {
                const players = parseInt(document.getElementById(`exp${expNum}-players`).value);
                const imposters = parseInt(document.getElementById(`exp${expNum}-imposters`).value);
                return { players, imposters };
            },

            // Calculate theoretical probability
            calculateTheory(players, imposters) {
                return imposters / players;
            },

            // Update theory displays
            updateTheoryDisplays() {
                for (let i = 1; i <= 3; i++) {
                    const config = this.getExperimentConfig(i);
                    const prob = this.calculateTheory(config.players, config.imposters);
                    const percent = (prob * 100).toFixed(2);

                    document.getElementById(`exp${i}-theory-percent`).textContent = percent + '%';
                    document.getElementById(`exp${i}-theory-fraction`).textContent =
                        `(${config.imposters}/${config.players})`;
                }
            },

            // Fisher-Yates shuffle to select imposters
            selectImposters(playerCount, imposterCount) {
                const players = Array.from({ length: playerCount }, (_, i) => i);

                for (let i = players.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [players[i], players[j]] = [players[j], players[i]];
                }

                return players.slice(0, imposterCount);
            },

            // Run a single selection
            runSingleSelection(players, imposters) {
                const selected = this.selectImposters(players, imposters);
                return selected.includes(0); // Jen is always index 0
            },

            // Run experiment with live updates and convergence tracking
            async runExperiment(expNum, totalSelections) {
                const config = this.getExperimentConfig(expNum);

                // Validate
                if (config.imposters > config.players) {
                    alert(`Experiment ${expNum}: Imposters cannot exceed players!`);
                    return null;
                }

                // Show progress
                document.getElementById(`exp${expNum}-empty`).style.display = 'none';
                document.getElementById(`exp${expNum}-results`).classList.remove('active');
                document.getElementById(`exp${expNum}-progress`).classList.add('active');

                let jenSelected = 0;
                const updateInterval = Math.max(1, Math.floor(totalSelections / 100));

                // Track convergence data
                const convergenceData = [];

                // For small runs, track every point. For large runs, use sample points
                const trackEveryPoint = totalSelections <= 100;
                const samplePoints = [10, 50, 100, 250, 500, 750, 1000, 2500, 5000, 7500, 10000];

                for (let i = 0; i < totalSelections; i++) {
                    if (this.runSingleSelection(config.players, config.imposters)) {
                        jenSelected++;
                    }

                    // Store convergence data
                    const currentTrial = i + 1;
                    const shouldTrack = trackEveryPoint ||
                                       samplePoints.includes(currentTrial) ||
                                       currentTrial === totalSelections;

                    if (shouldTrack) {
                        const currentPercent = (jenSelected / currentTrial) * 100;
                        convergenceData.push({
                            trial: currentTrial,
                            percent: currentPercent
                        });
                    }

                    // Update progress
                    if (i % updateInterval === 0 || i === totalSelections - 1) {
                        const progress = ((i + 1) / totalSelections) * 100;
                        document.getElementById(`exp${expNum}-progress-fill`).style.width = progress + '%';
                        document.getElementById(`exp${expNum}-progress-text`).textContent =
                            `${i + 1} / ${totalSelections}`;

                        await this.yield();
                    }
                }

                // Hide progress, show results
                document.getElementById(`exp${expNum}-progress`).classList.remove('active');
                document.getElementById(`exp${expNum}-results`).classList.add('active');

                const theoryPercent = this.calculateTheory(config.players, config.imposters) * 100;

                // Calculate expected range (95% confidence interval)
                const p = config.imposters / config.players;
                const se = Math.sqrt((p * (1 - p)) / totalSelections);
                const margin = 1.96 * se * 100; // 95% CI
                const expectedMin = theoryPercent - margin;
                const expectedMax = theoryPercent + margin;

                return {
                    total: totalSelections,
                    selected: jenSelected,
                    actualPercent: (jenSelected / totalSelections) * 100,
                    theoryPercent: theoryPercent,
                    convergenceData: convergenceData,
                    expectedRange: {
                        min: expectedMin,
                        max: expectedMax,
                        margin: margin
                    }
                };
            },

            // Display results
            displayResults(expNum, results) {
                document.getElementById(`exp${expNum}-total`).textContent = results.total;
                document.getElementById(`exp${expNum}-selected`).textContent = results.selected;
                document.getElementById(`exp${expNum}-actual-percent`).textContent =
                    results.actualPercent.toFixed(2) + '%';

                const diff = results.actualPercent - results.theoryPercent;
                const diffEl = document.getElementById(`exp${expNum}-diff`);
                const absDiff = Math.abs(diff);

                // Check if within expected range
                const withinRange = results.actualPercent >= results.expectedRange.min &&
                                   results.actualPercent <= results.expectedRange.max;

                const rangeText = `Expected range: ${results.expectedRange.min.toFixed(1)}% - ${results.expectedRange.max.toFixed(1)}%`;

                if (withinRange && absDiff < 1) {
                    diffEl.className = 'difference good';
                    diffEl.textContent = `‚úì ${diff >= 0 ? '+' : ''}${diff.toFixed(2)}% difference - Excellent! ${rangeText}`;
                } else if (withinRange) {
                    diffEl.className = 'difference good';
                    diffEl.textContent = `‚úì ${diff >= 0 ? '+' : ''}${diff.toFixed(2)}% difference - Within expected range! ${rangeText}`;
                } else {
                    diffEl.className = 'difference warning';
                    diffEl.textContent = `‚ö† ${diff >= 0 ? '+' : ''}${diff.toFixed(2)}% difference - Outside expected range (${rangeText}). This is rare but possible - try more trials!`;
                }

                // Update compound probability contributions
                const pSelected = results.actualPercent / 100;
                const pNotSelected = 1 - pSelected;

                document.getElementById(`exp${expNum}-p-selected`).textContent = pSelected.toFixed(4);
                document.getElementById(`exp${expNum}-p-not-selected`).textContent = pNotSelected.toFixed(4);

                this.updateChart(expNum, results);

                // Show convergence if we have data
                if (results.convergenceData && results.convergenceData.length > 1) {
                    this.updateConvergenceChart(expNum, results);
                }
            },

            // Update individual chart - Show convergence over time
            updateChart(expNum, results) {
                const ctx = document.getElementById(`exp${expNum}-chart`).getContext('2d');

                if (this.charts[expNum]) {
                    this.charts[expNum].destroy();
                }

                // Use convergence data if available, otherwise show simple bar
                if (results.convergenceData && results.convergenceData.length > 1) {
                    this.updateConvergenceChart(expNum, results);
                } else {
                    // Fallback: simple bar chart
                    const notSelected = results.total - results.selected;

                    this.charts[expNum] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Not Selected', 'Selected'],
                            datasets: [{
                                data: [notSelected, results.selected],
                                backgroundColor: ['#E2E8F0', '#FF6B6B']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            },

            // Update convergence chart - Shows percentage approaching theory over time
            updateConvergenceChart(expNum, results) {
                const ctx = document.getElementById(`exp${expNum}-chart`).getContext('2d');

                if (this.charts[expNum]) {
                    this.charts[expNum].destroy();
                }

                const labels = results.convergenceData.map(d => d.trial);
                const percentages = results.convergenceData.map(d => d.percent);
                const theoryLine = Array(labels.length).fill(results.theoryPercent);

                this.charts[expNum] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Actual %',
                                data: percentages,
                                borderColor: '#FF6B6B',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                borderWidth: 3,
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Theory %',
                                data: theoryLine,
                                borderColor: '#4ECDC4',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Convergence to Theory',
                                font: { size: 12 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Number of Trials',
                                    font: { size: 11 }
                                },
                                ticks: {
                                    font: { size: 10 }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Selection %',
                                    font: { size: 11 }
                                },
                                ticks: {
                                    font: { size: 10 },
                                    callback: (value) => value.toFixed(0) + '%'
                                }
                            }
                        }
                    }
                });
            },

            // Run all experiments
            async runAllExperiments() {
                const button = document.getElementById('run-button');
                button.disabled = true;

                this.updateTheoryDisplays();
                const count = this.getCount();

                const results = [];
                for (let i = 1; i <= 3; i++) {
                    const result = await this.runExperiment(i, count);
                    if (result) {
                        results.push({ expNum: i, ...result });
                        this.displayResults(i, result);
                    }
                }

                if (results.length === 3) {
                    this.updateComparisonChart(results);
                    this.calculatePatternProbability(results);
                }

                button.disabled = false;
            },

            // Calculate Jen's pattern probability (selected in 1, NOT in 2, selected in 3)
            calculatePatternProbability(results) {
                document.getElementById('pattern-analysis').style.display = 'block';

                // Extract probabilities
                const p1Selected = results[0].actualPercent / 100;
                const p2Selected = results[1].actualPercent / 100;
                const p3Selected = results[2].actualPercent / 100;

                const p2NotSelected = 1 - p2Selected;

                // Calculate compound probability
                const compoundProb = p1Selected * p2NotSelected * p3Selected;
                const compoundPercent = compoundProb * 100;
                const odds = Math.round(1 / compoundProb);

                // Update formula display
                document.getElementById('formula-calculation').textContent =
                    `= ${p1Selected.toFixed(4)} √ó ${p2NotSelected.toFixed(4)} √ó ${p3Selected.toFixed(4)}`;
                document.getElementById('formula-result').textContent =
                    `= ${compoundProb.toFixed(4)} = ${compoundPercent.toFixed(2)}%`;

                // Update comparison cards
                document.getElementById('pattern-experimental').textContent = compoundPercent.toFixed(2) + '%';
                document.getElementById('pattern-experimental-odds').textContent = `(1 in ${odds})`;

                // Calculate theoretical
                const config1 = this.getExperimentConfig(1);
                const config2 = this.getExperimentConfig(2);
                const config3 = this.getExperimentConfig(3);

                const theoreticalP1 = config1.imposters / config1.players;
                const theoreticalP2Not = 1 - (config2.imposters / config2.players);
                const theoreticalP3 = config3.imposters / config3.players;
                const theoreticalCompound = theoreticalP1 * theoreticalP2Not * theoreticalP3;
                const theoreticalPercent = theoreticalCompound * 100;

                // Verdict
                const diff = Math.abs(compoundPercent - theoreticalPercent);
                const verdictEl = document.getElementById('pattern-verdict');

                if (diff < 0.5) {
                    verdictEl.innerHTML = `‚úÖ <strong>Excellent Match!</strong> Experimental result (${compoundPercent.toFixed(2)}%) matches theory (${theoreticalPercent.toFixed(2)}%) within 0.5%`;
                    verdictEl.style.color = '#22543D';
                } else if (diff < 1.5) {
                    verdictEl.innerHTML = `‚úì <strong>Good Match!</strong> Experimental result (${compoundPercent.toFixed(2)}%) is close to theory (${theoreticalPercent.toFixed(2)}%)`;
                    verdictEl.style.color = '#2F855A';
                } else {
                    verdictEl.innerHTML = `‚ö†Ô∏è <strong>Run more trials!</strong> Difference of ${diff.toFixed(2)}% suggests sample size may be too small. Try 10,000+ selections.`;
                    verdictEl.style.color = '#7D6608';
                }

                // Show the full story simulation section
                document.getElementById('jen-story-simulation').style.display = 'block';
            },

            // Run Full Jen Story Simulation
            async runJenStorySimulation(totalGames) {
                const config1 = this.getExperimentConfig(1);
                const config2 = this.getExperimentConfig(2);
                const config3 = this.getExperimentConfig(3);

                // Show progress
                document.getElementById('jen-story-progress').style.display = 'block';
                document.getElementById('jen-story-results').style.display = 'none';
                document.getElementById('jen-story-total').textContent = totalGames;

                let matchingGames = 0;
                const updateInterval = Math.max(1, Math.floor(totalGames / 100));

                for (let i = 0; i < totalGames; i++) {
                    // Run 3 rounds
                    const r1Selected = this.runSingleSelection(config1.players, config1.imposters);
                    const r2Selected = this.runSingleSelection(config2.players, config2.imposters);
                    const r3Selected = this.runSingleSelection(config3.players, config3.imposters);

                    // Check if matches Jen's pattern: selected in R1, NOT in R2, selected in R3
                    if (r1Selected && !r2Selected && r3Selected) {
                        matchingGames++;
                    }

                    // Update progress
                    if (i % updateInterval === 0 || i === totalGames - 1) {
                        const progress = ((i + 1) / totalGames) * 100;
                        document.getElementById('jen-story-progress-fill').style.width = progress + '%';
                        document.getElementById('jen-story-current').textContent = (i + 1);
                        await this.yield();
                    }
                }

                // Calculate results
                const simPercent = (matchingGames / totalGames) * 100;
                const simOdds = totalGames / matchingGames;

                // Display results
                document.getElementById('jen-story-progress').style.display = 'none';
                document.getElementById('jen-story-results').style.display = 'block';

                document.getElementById('jen-story-matches').textContent = matchingGames;
                document.getElementById('jen-story-games').textContent = totalGames;
                document.getElementById('jen-story-percent').textContent = `Percentage: ${simPercent.toFixed(2)}%`;
                document.getElementById('jen-story-sim-percent').textContent = simPercent.toFixed(2) + '%';
                document.getElementById('jen-story-sim-odds').textContent = `(1 in ${Math.round(simOdds)})`;

                // Calculate theoretical
                const theoreticalP1 = config1.imposters / config1.players;
                const theoreticalP2Not = 1 - (config2.imposters / config2.players);
                const theoreticalP3 = config3.imposters / config3.players;
                const theoreticalCompound = theoreticalP1 * theoreticalP2Not * theoreticalP3;
                const theoreticalPercent = theoreticalCompound * 100;

                // Verdict
                const diff = Math.abs(simPercent - theoreticalPercent);
                const verdictEl = document.getElementById('jen-story-verdict');

                if (diff < 0.5) {
                    verdictEl.innerHTML = `‚úÖ <strong>Perfect Validation!</strong> Full simulation (${simPercent.toFixed(2)}%) matches theory (${theoreticalPercent.toFixed(2)}%)`;
                    verdictEl.style.color = '#22543D';
                } else if (diff < 1.5) {
                    verdictEl.innerHTML = `‚úì <strong>Validated!</strong> Full simulation (${simPercent.toFixed(2)}%) confirms theory (${theoreticalPercent.toFixed(2)}%)`;
                    verdictEl.style.color = '#2F855A';
                } else {
                    verdictEl.innerHTML = `‚ö†Ô∏è Difference: ${diff.toFixed(2)}%. Try 10,000+ games for better accuracy.`;
                    verdictEl.style.color = '#7D6608';
                }
            },

            // Update comparison chart
            updateComparisonChart(results) {
                document.getElementById('comparison-section').style.display = 'block';

                const ctx = document.getElementById('comparison-chart').getContext('2d');

                if (this.comparisonChart) {
                    this.comparisonChart.destroy();
                }

                const labels = results.map(r => `Experiment ${r.expNum}`);
                const actualData = results.map(r => r.actualPercent);
                const theoryData = results.map(r => r.theoryPercent);

                this.comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Theory %',
                                data: theoryData,
                                backgroundColor: '#4ECDC4',
                                borderColor: '#3EBDB5',
                                borderWidth: 2
                            },
                            {
                                label: 'Actual %',
                                data: actualData,
                                backgroundColor: '#FF6B6B',
                                borderColor: '#EE5A5A',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Theory vs Actual - All Experiments',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Selection Percentage (%)'
                                }
                            }
                        }
                    }
                });
            },

            // Reset to Jen scenario
            resetToJenScenario() {
                document.getElementById('exp1-players').value = 17;
                document.getElementById('exp1-imposters').value = 3;
                document.getElementById('exp2-players').value = 17;
                document.getElementById('exp2-imposters').value = 3;
                document.getElementById('exp3-players').value = 18;
                document.getElementById('exp3-imposters').value = 2;
                this.updateTheoryDisplays();
            },

            // Clear all results
            clearResults() {
                for (let i = 1; i <= 3; i++) {
                    document.getElementById(`exp${i}-results`).classList.remove('active');
                    document.getElementById(`exp${i}-progress`).classList.remove('active');
                    document.getElementById(`exp${i}-empty`).style.display = 'block';

                    if (this.charts[i]) {
                        this.charts[i].destroy();
                    }
                }

                document.getElementById('comparison-section').style.display = 'none';
                if (this.comparisonChart) {
                    this.comparisonChart.destroy();
                }
            },

            // Utility
            yield() {
                return new Promise(resolve => setTimeout(resolve, 0));
            }
        };

        // Initialize
        window.addEventListener('load', () => {
            app.updateTheoryDisplays();

            // Update theory when inputs change
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (input.id.includes('players') || input.id.includes('imposters')) {
                    input.addEventListener('change', () => app.updateTheoryDisplays());
                }
            });

            console.log('üé≤ Imposter Selection Experiments loaded!');
            console.log('Run experiments with different counts to see Law of Large Numbers');
        });
    </script>
</body>
</html>
